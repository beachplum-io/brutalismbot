StartAt: GetSecret
States:
  GetSecret:
    Type: Task
    Resource: arn:aws:states:::aws-sdk:secretsmanager:getSecretValue
    ResultPath: $.secret
    Next: PostMessage
    Parameters:
      SecretId: ${secret_id}
    ResultSelector:
      SecretValue.$: States.StringToJson($.SecretString)
  PostMessage:
    Type: Task
    Resource: ${http_function_arn}
    End: true
    Parameters:
      method: POST
      url: https://slack.com/api/chat.postMessage
      headers:
        authorization.$: States.Format('Bearer {}', $.secret.SecretValue.SLACK_API_TOKEN)
        content-type: application/json; charset=utf-8
      body:
        channel: ${channel_id}
        text.$: States.Format('State machine {}', $.detail.status)
        blocks:
          - type: section
            text:
              type: plain_text
              text.$: States.Format('State machine {}', $.detail.status)
          - type: context
            elements:
              - type: plain_text
                emoji: false
                text.$: $.detail.stateMachineArn
          - type: actions
            elements:
              - type: button
                action_id: delete_me
                value: delete_me
                text:
                  type: plain_text
                  text: Dismiss
              - type: button
                action_id: open_execution
                value.$: $.detail.executionArn
                url.$: States.Format('https://{}.console.aws.amazon.com/states/home?region={}#/v2/executions/details/{}', $.region, $.region, $.detail.executionArn)
                text:
                  type: plain_text
                  text: Open
