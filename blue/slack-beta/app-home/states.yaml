---
StartAt: GetRequest
States:
  GetRequest:
    Type: Parallel
    Next: SendRequest
    Branches:
      - StartAt: GetToken
        States:
          GetToken:
            Type: Task
            Resource: arn:aws:states:::aws-sdk:secretsmanager:getSecretValue
            End: true
            OutputPath: $.SecretValue.SLACK_API_TOKEN
            Parameters:
              SecretId: ${secret_id}
            ResultSelector:
              SecretValue.$: States.StringToJson($.SecretString)
      - StartAt: GetView
        States:
          GetView:
            Type: Task
            Resource: ${home_view_arn}
            End: true
            Retry:
              - BackoffRate: 2
                IntervalSeconds: 3
                MaxAttempts: 4
                ErrorEquals:
                  - States.ALL
    ResultSelector:
      method: POST
      url: https://slack.com/api/views.publish
      headers:
        authorization.$: States.Format('Bearer {}', $[0])
        content-type: application/json; charset=utf-8
      body:
        user_id: ${user_id}
        view.$: $[1]
  SendRequest:
    Type: Task
    Resource: ${http_function_arn}
    End: true
    Parameters:
      method.$: $.method
      url.$: $.url
      headers.$: $.headers
      body:
        user_id.$: $.body.user_id
        view.$: States.JsonToString($.body.view)
    Retry:
      - BackoffRate: 2
        IntervalSeconds: 3
        MaxAttempts: 4
        ErrorEquals:
          - States.ALL
